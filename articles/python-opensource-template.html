<!DOCTYPE html>
<html lang="en">
    <head>
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-155995840-1"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'UA-155995840-1');
        </script>

        <meta charset="utf-8" />
        <meta http-equiv="x-ua-compatible" content="ie=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="description" content="Ultimate template for opensource Python projects">
        <title>Opensource python project template| Jakub Tes√°rek</title>
        <link rel="stylesheet" href="../style/main.css" />
        <link rel="stylesheet" href="../style/color-brewer.css">
        <script src="../script/highlight.pack.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script type="text/javascript" src="//downloads.mailchimp.com/js/signup-forms/popup/unique-methods/embed.js" data-dojo-config="usePlainJson: true, isDebug: false"></script><script type="text/javascript">window.dojoRequire(["mojo/signup-forms/Loader"], function(L) { L.start({"baseUrl":"mc.us4.list-manage.com","uuid":"db9cdab3c81c5706fb0ede08a","lid":"44f897bb92","uniqueMethods":true}) })</script>
    </head>
    <body>
        <header>
            <menu>
                <ul class="navigation">
                    <li><a href="https://tesarek.me">Home</a></li>
                    <li><a href="https://tesarek.me#publications">Publications</a></li>
                    <li><a href="https://tesarek.us4.list-manage.com/subscribe/post?u=db9cdab3c81c5706fb0ede08a&id=44f897bb92">Subscribe</a></li>
                </ul>
            </menu>
        </header>
        <main>
            <article class="content">
                <header>
                    <h1>Ultimate template for Python projects</h1>
                    <p>Starting new project is fun but sometimes tedious endeavor. You have a great idea and want to start coding
                        but first you have to setup CI/CD, start writing documentation, figure out how you're going to publish to PyPi
                        all lot of other tasks that just keep you from coding.</p>
                </header>
                <p>I've created a template that can help you get all the annoying details off the table in couple of minutes so you can
                    start working on the next big thing. In this article we'll start new project in Python and also
                    <ul>
                        <li><a href="#install-dependencis">Install dependencies</a></li>
                        <li><a href="#unittest">Run unittests</a></li>
                        <li><a href="#doctests">Run doctests</a></li>
                        <li><a href="#pylint">Run a code linter</a></li>
                        <li><a href="#mypy">Test our type hinting</a></li>
                        <li><a href="#packaging">Package the source code</a></li>
                        <li><a href="#publishing">Publish package to PyPi</a></li>
                        <li><a href="#ci-cd">Setup a CI/CD process</a></li>
                        <li><a href="#encrypt-secrets">Encrypt secrets</a></li>
                        <li><a href="#readme">Add cool badges to readme</a></li>
                    </ul>
                </p>
                <aside><p>If you understand the tools used in this article, you can skip to a <a href="#checklist">checklist at the end</a>.</p></aside>

                <p>To do all that we'll use <a href="https://github.com/JakubTesarek/python_template_project">Python template project</a>.
                    You can either fork it or clone and set the upstream to your own repository.</p>
                    <pre><code class="bash">$ git clone git@github.com:JakubTesarek/python_template_project.git
$ cd python_template_project
$ git remote set-url origin git@github.com:&lt;author_username&gt;/&lt;project_name&gt;.git</code></pre>
                <p>If you want to look at a project that uses this template, check out <a href="https://github.com/JakubTesarek/colltools">CollTools on my Github</a>.</p>

                <h2>Project name</h2>
                <p><a href="https://martinfowler.com/bliki/TwoHardThings.html">Naming is hard.</a> So make sure you come up with a good name for your project. In this tutorial
                    I'll assume that you project name is something that's also a valid python module name. <code>world_dominance</code> will work. <code>One Billion Dollar$</code> will not.
                    You are smart enought to figure out where the name actually matters and adapt accordingly.</p>
                <p>First thing we'll have to do is to change name of directory <code>project_name</code> to the actual name. This is the directory where we'll store our code. You can see it
                    already contains <code>__init__.py</code> and one function. Feel free to change it.</p>

                <h2>Makefile</h2>
                <p>The template contains a <code>Makefile</code> that makes it easier to execute some often-used actions like running all test, generating documentation etc.</p>
                <p>Before we can use it, we have to open in and set the name of our project on the first line.</p>
                <pre><code class="makefile"><i class="add">proj_dir = actual_project_name</i>
all:
	@echo 'test | clean | build | doc'

test:
	python -m doctest -v $(proj_dir)/*.py
	py.test tests \
		--cov $(proj_dir) \
		--cov-report html \
		--cov-report term \
		--cov-fail-under=100
	pylint $(proj_dir)
	mypy $(proj_dir)

...</code></pre>

                <p>To list all available commands, just type <code>make</code> in the terminal without any arguments</p>
                <pre><code class="bash">$ make
test | clean | build | doc</code></pre>

                <aside>
                    <p>We will discuss the individual commands when we need them. If you want to learn more about Makefile, good place to start is <a href="https://en.wikipedia.org/wiki/Makefile">Wikipedia</a>
                        or <a href="https://opensource.com/article/18/8/what-how-makefile">Opensource.com</a>.</p>
                </aside>

                <h2 id="install-dependencis">Install dependencies</h2>
                <p>In file <code>requirements-test.txt</code> is a list of dependencies of this project. These dependencies are required to run tests, collect code coverage and generate documentation.
                    We need to install using pip:</p>
                <pre><code class="bash">$ pip install -r requirements.txt</code></pre>

                <p>This will install them globally using your default Python. I reccommend to <a href="https://virtualenv.pypa.io/en/latest/">setup a virtualenv</a> first.</p>

                <aside>
                    <p>It's good practice to keep requirements for running tests and similar tasks separate from main dependency list. Users of your software probably don't want
                        to install these dependencies.</p>
                </aside>

                <h2>Running tests</h2>
                <p>If you successfully installed the dependencies, you can run the tests. The easiest way is to use the included <code>Makefile</code>: <code>$ make test</code></a>
                <p>It will start all the tests. You can also run all them individually.</p>

                <h3 id="unittest">Unittests</h3>
                <pre><code class="bash">$ py.test tests \
		--cov project_name \
		--cov-report html \
		--cov-report term \
		--cov-fail-under=100

=== test session starts ===
collected 1 item

tests/project_name.py .         [100%]

---------- coverage: platform darwin, python 3.6.6-final-0 -----------
Name                       Stmts   Miss  Cover
----------------------------------------------
project_name/__init__.py       2      0   100%
Coverage HTML written to dir htmlcov

Required test coverage of 100% reached. Total coverage: 100.00%

=== 1 passed in 0.03s ===</code></pre>

                <p>First it runs unittests located in directory <code>tests/</code> using <a href="https://docs.pytest.org/en/latest/">pytest</a>
                    and measures the <a href="https://readthedocs.org/projects/pytest-cov/">code coverage</a>.
                    The argument <code>--cov-fail-under=100</code> makes sure the tests fail if we don't reach 100% code coverage.</p>

                <p>It will also generate html coverage report and store it <code>htmlcov</code>. You can open the <code>htmlcov/index.html</code>
                    in your browser.
                    <img src="../media/python-opensource-template/code-coverage-index.png" />
                    <img src="../media/python-opensource-template/code-coverage-init.png" />
                </p>

                <h3 id="doctests">Doctests</h3>
                <p><a href="https://docs.python.org/3.7/library/doctest.html">Doctest</a> is a module that reads your docstrings and looks for
                    strings that resemble python code. It then executes them and checks if they work as documented.</p>
                <pre><code class="bash">$ python -m doctest -v project_name/*.py
Trying:
    factorial(10)
Expecting:
    3628800
ok
1 items had no tests:
    __init__
1 items passed all tests:
   1 tests in __init__.factorial
1 tests in 2 items.
1 passed and 0 failed.
Test passed.</code></pre>

                <h3 id="pylint">Pylint</h3>
                <p><a href="https://www.pylint.org/">Pylint</a> is a code analyzer (linter) for Python. It measures code quality and reports it's score.</p>
                <pre><code class="bash">pylint project_name

-------------------------------------------------------------------
Your code has been rated at 10.00/10 (previous run: 5.00/10, +5.00)</code></pre>

                <p>You can modify the rules it uses in <code>.pylintrc</code>. It's not included in this project because we use the defaults.</p>


                <h3 id="mypy">Mypy</h3>
                <p><a href="https://mypy.readthedocs.io/en/latest/">Mypy</a> is also a code analyzer. If you use <a class="https://docs.python.org/3.7/library/typing.html">type hinting</a>,
                    it can check if you define and use all the types correctly.</p>
                <pre><code class="bash">$ mypy project_name
Success: no issues found in 1 source file</pre></code>

                <h2 id="packaging">Packaging the project</h2>
                <p>We also want to build the project so other people can install it. We will use <code>setup.py</code> to build both <a href="https://packaging.python.org/glossary/">source archive and build distribution</a>.</p>
                <p>We have to edit the <code>setup.py</code> and fill in the correct values.</p>
                <pre><code class="python">from setuptools import setup, find_packages
import os


def extras_require():
    """ Generate list of dependencies from `requirements-test.txt` """
    with open('requirements-test.txt') as fp:
        return {'test': fp.read()}

def long_description():
    """ Generate long description from `README.rst` """
    with open('README.rst') as readme:
        return readme.read()

def version():
    """ Finds current version

    We can fill in the version manually every time we build our package. But it's
    better to find it automatically. When we'll build the package using Travis,
    it will define system variable `TRAVIS_TAG` with the name of the github tag that
    triggered the build. We'll use that if it's available.
    Otherwise we'll find lastest tag in curreng repository and use it.
    """
    version = os.environ.get('TRAVIS_TAG', '')
    if not version:
        version = os.popen('git describe --match "[0-9]*" --tags HEAD').read()
    return version.strip()

setup(
    name='<project_name>', # Replace with actual project name
    version=version(),
    python_requires='&gt;=3.6',
    description='&lt;description&gt;', # Replace with short description
    long_description=long_description(),
    long_description_content_type='text/x-rst',
    url='&lt;github_url&gt;', # Replace with github url of your project
    author='&lt;author_name&gt;', # Replace with your real name
    author_email='&lt;author_email&gt;', # Replace with your real email address
    license='APACHE LICENSE 2.0',
    classifiers=[
        'Development Status :: 4 - Beta',
        'License :: OSI Approved :: Apache Software License',
        'Intended Audience :: Developers',
        'Programming Language :: Python :: 3.6',
        'Programming Language :: Python :: 3.7'
    ],
    packages=find_packages(),
    extras_require=extras_require(),
    # py_modules = ['module'], # modify if you want to include some module in project root dir
    # include_package_data=True, # uncomment if you want to include some non-python files
    # install_requires=install_requires(), # if your package has dependencies, add them here
)</code></pre>

                <aside>
                    <p>Packaging can be complex process that offers many more customizations. To learn more, I reccommend reading <a href="https://packaging.python.org/tutorials/packaging-projects/">the documentation</a>.</p>
                </aside>

                <p>We can almost build a package from our project for the first time. We just have to create a version tag: <code>$ git tag 1.0.1</code>. This is used by the build script to determine
                    the version we are building. In the <a href="#ci-cd">CI/CD section</a> we'll look at better way to do this.</p>

                <p>We will use the prepared script from <code>Makefile</code> again.</p>
                <pre><code class="bash">$ make build
rm -rf *.pyc __pycache__
rm -rf project_name.egg-info build dist
rm -rf .mypy_cache
rm -rf .pytest_cache
rm -rf htmlcov .coverage
Removing everything under 'build'...
python setup.py sdist bdist_wheel

...

adding 'tests/__init__.py'
adding 'tests/test_project_name.py'
adding 'project_name-1.0.1.dist-info/LICENCE'
adding 'project_name-1.0.1.dist-info/METADATA'
adding 'project_name-1.0.1.dist-info/WHEEL'
adding 'project_name-1.0.1.dist-info/top_level.txt'
adding 'project_name-1.0.1.dist-info/RECORD'
removing build/bdist.x86_64/wheel</pre></code>

                <p>First it removes all cache files and coverage reports so we don't accidentally package something we don't want to. Then it
                    creates two distribution packages.</p>
                    <pre><code class="bash">$ ls dist
project_name-1.0.1-py3-none-any.whl
project_name-1.0.1.tar.gz</code></pre>

                <h2 id="publishing">Publishing to PyPi</h2>
                <p>In this step we will upload our package to <a href="https://pypi.org/">pypi.org</a> so other people can install it. If you
                    don't have an account already, go ahead and <a href="https://pypi.org/account/register/">register</a>.</p>
                <p>From local computer we'll use utility called <a href="https://pypi.org/project/twine/">Twine</a>. You can run it like this:
                    <code>$ twine upload dist/*</code>. It will ask you for your PyPi username and password and upload your package.</p>

                <p>In next step we'll replace this manual process with automated CI/CD.</p>

                <h2 id="ci-cd">CI/CD</h2>
                <p>For continuous integration and deployment we'll use <a href="https://travis-ci.org/">Travis</a>. It's free for opensource projects
                    and has good integration with Github.</p>
                <p>First you need to create an account on <a href="https://travis-ci.org/">Travis</a>. Simply log in using your Github account and
                    Travis will automatically sync all your repositories. Go ahead and enable you project.
                    <img src="../media/python-opensource-template/travis.png" />
                </p>
                <p>Travis will create a webhook in you project that will trigger every time someone pushes code to your repository or creates a pull request.
                    <img src="../media/python-opensource-template/travis-webhook.png" />
                </p>

                <h3>Travis configuration</h3>
                <p>In the template project I included a file called <code>.travis.yml</code> that serves as a configuration for the build process.</p>

                <pre><code class="yml">os: linux
dist: xenial
language: python
python:
- '3.7'
- '3.6'
install:
- sudo apt-get install python-enchant
- pip install -r requirements-test.txt
- pip install .
script:
- make test
- make build
after_success:
- codecov
deploy:
  - provider: pypi
    username:
      secure: &lt;pypi_username&gt;
    password:
      secure: &lt;pypi_password&gt;
    on:
      tags: true
      condition: $TRAVIS_PYTHON_VERSION = 3.6
  - provider: releases
    overwrite: true
    token:
      secure: &lt;github_token&gt;
    file_glob: true
    file: dist/*
    on:
      tags: true
      condition: $TRAVIS_PYTHON_VERSION = 3.6</code></pre>

                <p>You don't need to change much in this file, but I'll explain to you the meaning of configuration directives so you can customize the CI/CD process for your needs.</p>

                <p><code>Os</code> and <code>dist</code> specify which operating system we want to use. Python 3.7 is only available on
                    <code>xenial</code> so you have to use it, if you want to build packages for that Python version.</p>

                <p><code>Language</code> is obviously used to tell Travis what language we are using, and the <code>python</code> section
                    contains a list of Python versions. Travis will start new build process for each versions.</p>

                <p><code>Install</code> contains a list of bash commands that we need to execute in order to "install" our application. After
                    this step, the environment should be ready to test and build our application.</p>

                <p><code>Script</code> lists all steps necessary to build our application. Travis runs all the steps sequentially and if one fails
                    the build process stops. That's why we first run all the tests and only if all of them pass, we attempt to build the application.
                    At the beginning Travis clones the whole repository including the <code>Makefile</code> so we can use that to run the tests and build.</p>

                <p><code>After_success</code> is a list of steps that run after the build is done. In our case we use <code>codecov</code> module
                    to report code coverage to <a href="https://codecov.io/">codecov.io</a>.</p>

                <p><code>Deploy</code> describes how to deploy our application. We will publish the result package to PyPi and also push the artifacts to <a href="https://help.github.com/en/github/administering-a-repository/creating-releases">Github Releases</a>.

                <p>Each section starts with <code>provider</code> which is <a href="https://docs.travis-ci.com/user/deployment/releases/">one of many providers supported by Travis</a>.</p>
                <p>The <code>on</code> section list conditions that have to be met in order to start the deploy. We want to trigger deploy only
                    on commits associated with a git tag. Travis will set the name of the tag in a system variable <code>TRAVIS_TAG</code> at the
                    beginning so we can be sure we are building and deploying version equal to that tag.</p>

                <p>As I mentioned before, Travis runs the whole config file for all language versions we specify. We use two, which means we would
                    also try to deploy the same version twice. Github doesn't mind but PyPi reports an error if we try do release a version that
                    allredy exists. The easiest solution I could find was to simply say I want to deploy only version 3.6.</p>

                <p>PyPi module detects file to release automatically but Github needs a little help. Using the <code>file_glob</code> and
                    <code>file</code> directives we simply release everything in <code>dist</code> directory.</p>

                <p>The last thing missing are the secrets to PyPi and Github. We can either set them in the Travis UI or we can paste them to
                    the config file. If we do so, we have to encrypt them because the config file is publicly available. For PyPi put in the username
                    and password you registered in. For Github you can use username/password but reccommended way is to create a <a href="https://docs.travis-ci.com/user/deployment/releases/#authenticating-with-an-oauth-token">dedicated machine
                    user and use his oAuth token</a>.</p>

                <h3 id="encrypt-secrets">Encrypting secrets</h3>
                <p>You can install <a href="https://github.com/travis-ci/travis.rb">Travis terminal client</a> but it's quite heavy so I prefer using python implementation of <a href="https://pypi.org/project/travis-encrypt/">travis-encrypt</a>.</p>
                <pre><code class="bash">$ travis-encrypt your_username repository_name
Password: ********

Please add the following to your .travis.yml:
secure: W4kXPM12VWxnyWj/QeVw6lua+e ... ANtILgvNSZUvAsiIUl+iQs15x4/ph2dyY=</code></pre>

                <aside>
                    <p>Don't get confused by the prompt for <code>password</code>. Simply fill in the secret information you want to encrypt.</p>
                </aside>
                <p>When you encrypt the secrets, place them to appropriate place in <code>.travis.yml</code></p>

                <h2 id="documentation">Documentation</h2>
                <p>Each opensource project needs good documentation. The industry standard for Python projects is documentation generated with
                    <a href="http://www.sphinx-doc.org/en/master/">Sphinx</a> and published on <a href="https://readthedocs.org/">Read the docs</a>.
                    The first one is a tool that can, among other things, generate html files from rst or markdown. The second one is free hosting
                    for your documentation that can also build your documentation.</p>

                <p>Sphinx is included in project dependencies so if you installed them, you should already be able to run <code>$ make doc</code>
                    which will generate html files in <code>docs/build/html/</code> and check your spelling. You can open your new documentation
                    with <code>$ open docs/build/html/index.html</code>.
                    <img src="../media/python-opensource-template/documentation.png" /></p>

                <h3>Adding pages</h3>
                <p>The documentation is empty so far but adding new pages is very easy. Create new file <code>docs/source/project_name.rst</code>. This
                    is a file in <a href="https://en.wikipedia.org/wiki/ReStructuredText">reStructuredText</a>. You can add any text in this file but we'll
                    look at how to generate documentation automatically from our source code.</p>

                <p>Macro called <code>automodule</code> will insert documentation generated from pydoc of a module given as an argument. Paste this code to <code>project_name.rst</code></p>
                <pre><code class="rst">Functions
=========

.. automodule:: project_name
   :members:</code></pre>

                <p>Automodule does all the magic. But <a href="https://www.sphinx-doc.org/en/master/usage/extensions/autodoc.html">there are other macros that can generate documentation</a>.</p>

                <p>Before we can generate the new page, we have to add it to the page tree. Open <code>docs/source/index.rst</code> and replace it with this code:</p>
                <pre><code class="rst">Welcome to &lt;project_name&gt; documentation!
========================================

.. toctree::
   :maxdepth: 2
   :caption: Contents:

<i class="add">   project_name</i>

Indices and tables
==================

* :ref:`genindex`
* :ref:`modindex`
* :ref:`search`</code></pre>

                <p>When you generate the documentation again, you'll see the new page and link to it on the index.
                    <img src="../media/python-opensource-template/documentation-index.png" />
                    <img src="../media/python-opensource-template/documentation-generated.png" />
                </p>

                <h3>Read the docs!</h3>
                <p><a href="https://readthedocs.org/">Read the Docs</a> is a platform for sharing documentation of opensource projects. It can
                    automatically build and publish your documentation straight from the Github repository. It's free, all you have to do is
                    to <a href="https://readthedocs.org/accounts/login/">sign in using your Github account</a>. Once you do, import the project
                    from your Github for which you want to build the docs.

                    <img src="../media/python-opensource-template/read-the-docs.png" />
                </p>

                <p>The project docs should start building immediately. If it doesn't, start the build manually with the "Build version" button.
                    Once it's finished, it will be available at <code>project_name.rtfd.io</code>.</p>

                <aside>
                    <p>Read the docs also sets up a commit hook in your repository so your documentation will automatically build every time you
                        push to master branch.</p>
                </aside>


                <h3>.readthedocs.yml</h3>
                <p>Remember the Sphinx plugins we installed earlier? We have to tell Read the Docs it should install them too. You can add project
                    dependencies in Read the docs administration but there's a better way. I prepared file <code>.readthedocs.yml</code> in the
                    project root that already contains all the necessary settings. If you need to modify how the documentation is built, this
                    is the correct place.</p>

                <pre><code class="yml">version: 2
sphinx:
  configuration: docs/source/conf.py
python:
  version: 3
  install:
    - requirements: requirements-test.txt</code></pre>

                <h2 id="badges">Badges</h2>
                <p><img src="../media/python-opensource-template/badges.png" /></p>
                <p>To make you project look more professional, you can add badges that will testify that everything works.</p>
                <p>In <code>README.rst</code> I prepared some of them for everything we set up so far. Simply replace the project
                    name and the path to your repository in the image paths to make them work.</p>


                <h2 id="checklist">Checklist</h2>
                <p>Congratulations! You just created and published a Python opensource project.</p>
                <p>For your convenience I include a checklist of all the necessary step.</p>
                <ul>
                    <li>Get the <a href="https://github.com/JakubTesarek/python_template_project">template</a></li>
                    <li><code>$ pip install -r requirements-test.txt</code></li>
                    <li>Rename the source dir</li>
                    <li>Change the source dir in <code>Makefile</code></li>
                    <li>Edit default variables in <code>setup.py</code></li>
                    <li>Edit default variables in <code>.travis.yml</code>
                    <li>Edit the badge paths in <code>Readme</code>
                    <li>Register project in <a href="https://travis-ci.org/">Travis</a></li>
                    <li>Register project in <a href="https://readthedocs.org/">Read the Docs</a></li>
                </ul>
                <aside>
                    <p>Did you find an issue with this article? Please <a href="https://github.com/JakubTesarek/tesarek.me/issues/new">file a bug report</a>
                        or even better, <a href="https://github.com/JakubTesarek/tesarek.me/edit/master/articles/python-opensource-template.html">send a pull request</a>.
                        Thank you!</a></p>
                </aside>
            </article>
        </main>
        <footer>
            <section>
                <a class="icon external" href="mailto:jakub@tesarek.me">&#xf0e0;</a>
                <a class="icon external" href="https://www.instagram.com/tesarekjakub/">&#xf16d;</a>
                <a class="icon external" href="https://github.com/JakubTesarek">&#xf300;</a>
                <a class="icon external" href="https://www.linkedin.com/in/jakubtesarek/">&#xf30c;</a>
        </footer>
    </body>
</html>
